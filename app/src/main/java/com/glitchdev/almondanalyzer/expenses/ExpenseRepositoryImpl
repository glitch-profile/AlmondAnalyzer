package com.glitchdev.almondanalyzer.core.data.repository

import com.glitchdev.almondanalyzer.core.data.db.Expense
import com.glitchdev.almondanalyzer.core.data.db.ExpenseDao
import com.glitchdev.almondanalyzer.expenses.domain.ExpenseRepository
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.onEach

class ExpenseRepositoryImpl(
    private val expenseDao: ExpenseDao
) : ExpenseRepository {

    private val cachedExpenses = MutableStateFlow<List<Expense>>(emptyList())

    override fun getAllExpenses(): Flow<List<Expense>> {
        return expenseDao.getAllExpenses()
            .onEach { cachedExpenses.value = it }
    }

    override suspend fun addExpense(expense: Expense) {
        expenseDao.insertExpense(expense)
    }

    override suspend fun deleteExpense(expense: Expense) {
        expenseDao.deleteExpense(expense)
    }

    override suspend fun updateExpense(expense: Expense) {
        expenseDao.updateExpense(expense)
    }

    fun getCachedExpenses(): List<Expense> = cachedExpenses.value
}